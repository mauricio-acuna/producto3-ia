name: ğŸš€ Portal 3 CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_NAME: Portal3-LLMOps
  PYTHON_VERSION: "3.9"

jobs:
  # Job 1: Linting y validaciÃ³n de documentaciÃ³n
  documentation-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: ğŸ“ Check Markdown files
      uses: articulate/actions-markdownlint@v1
      with:
        config: .markdownlint.json
        files: '**/*.md'
        ignore: node_modules
      continue-on-error: true
    
    - name: ğŸ” Validate links in documentation
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.markdown-link-check.json'
      continue-on-error: true

  # Job 2: Seguridad bÃ¡sica
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
      continue-on-error: true
    
    - name: ğŸ” Detect secrets
      uses: GitGuardian/ggshield-action@v1
      with:
        args: -v --all-policies
      env:
        GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
      continue-on-error: true

  # Job 3: Estructura del proyecto
  project-structure:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: ğŸ—ï¸ Validate project structure
      run: |
        echo "Validating Portal 3 project structure..."
        
        # Verificar estructura de mÃ³dulos
        required_dirs=(
          "modulos/modulo-a-observabilidad"
          "modulos/modulo-b-seguridad" 
          "modulos/modulo-c-costes"
          "modulos/modulo-d-resiliencia"
          "modulos/modulo-e-cicd"
          "templates"
          "ejemplos"
          "laboratorios"
          "capstone"
          "docs"
        )
        
        for dir in "${required_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "âœ… $dir exists"
          else
            echo "âŒ $dir missing"
            exit 1
          fi
        done
        
        # Verificar archivos clave
        required_files=(
          "README.md"
          "prd.md"
          ".gitignore"
          "config.md"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
        
        echo "ğŸ‰ Project structure validation passed!"

  # Job 4: Roadmap tracking
  roadmap-status:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: ğŸ“Š Check roadmap progress
      run: |
        echo "## ğŸ“ˆ Roadmap Progress" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Semana | Entregable | Estado |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| 1 | Landing + MÃ³dulo A (Observabilidad) | ğŸš§ En progreso |" >> $GITHUB_STEP_SUMMARY
        echo "| 2 | MÃ³dulo B (Seguridad) + lab prompt injection | â³ Pendiente |" >> $GITHUB_STEP_SUMMARY
        echo "| 3 | MÃ³dulo C (Costes) | â³ Pendiente |" >> $GITHUB_STEP_SUMMARY
        echo "| 4 | MÃ³dulo D (Resiliencia) | â³ Pendiente |" >> $GITHUB_STEP_SUMMARY
        echo "| 5 | MÃ³dulo E (CI/CD) | â³ Pendiente |" >> $GITHUB_STEP_SUMMARY
        echo "| 6 | Capstone final + rÃºbrica | â³ Pendiente |" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ Checklist Actual" >> $GITHUB_STEP_SUMMARY
        echo "- [x] PRD completo" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Estructura de proyecto" >> $GITHUB_STEP_SUMMARY
        echo "- [x] READMEs de mÃ³dulos" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Proyecto Capstone definido" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Contenido MÃ³dulo A" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Laboratorios implementados" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Templates de configuraciÃ³n" >> $GITHUB_STEP_SUMMARY

  # Job 5: NotificaciÃ³n de progreso
  notify-progress:
    runs-on: ubuntu-latest
    needs: [documentation-check, security-scan, project-structure, roadmap-status]
    if: always()
    steps:
    - name: ğŸ“¢ Progress Summary
      run: |
        echo "ğŸ¯ Portal 3 Development Status"
        echo "=============================="
        echo "ğŸ“ Documentation: ${{ needs.documentation-check.result }}"
        echo "ğŸ” Security: ${{ needs.security-scan.result }}"
        echo "ğŸ—ï¸ Structure: ${{ needs.project-structure.result }}"
        echo "ğŸ“Š Roadmap: ${{ needs.roadmap-status.result }}"
        echo ""
        echo "Next steps: Comenzar desarrollo de contenido MÃ³dulo A"
